###
# This file was automatically generated with nix-actions.
jobs:
  akhaten:
    name: Build akhaten
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build akhaten
      run: nix-build -A checks.machines.akhaten --out-link result-akhaten
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-akhaten
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/0\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/akhaten\\\",\\\"description\\\":\\\"akhaten\\\
        \"}\"\n"
  arcadia:
    name: Build arcadia
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build arcadia
      run: nix-build -A checks.machines.arcadia --out-link result-arcadia
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-arcadia
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/1\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/arcadia\\\",\\\"description\\\":\\\"arcadia\\\
        \"}\"\n"
  biblios:
    name: Build biblios
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build biblios
      run: nix-build -A checks.machines.biblios --out-link result-biblios
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-biblios
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/2\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/biblios\\\",\\\"description\\\":\\\"biblios\\\
        \"}\"\n"
  core-data:
    name: Build core-data
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build core-data
      run: nix-build -A checks.machines.core-data --out-link result-core-data
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-core-data
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/3\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/core-data\\\",\\\"description\\\":\\\"core-data\\\
        \"}\"\n"
  core-security:
    name: Build core-security
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build core-security
      run: nix-build -A checks.machines.core-security --out-link 
        result-core-security
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-core-security
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/4\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/core-security\\\",\\\"description\\\":\\\"\
        core-security\\\"}\"\n"
  darillium:
    name: Build darillium
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build darillium
      run: nix-build -A checks.machines.darillium --out-link result-darillium
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-darillium
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/5\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/darillium\\\",\\\"description\\\":\\\"darillium\\\
        \"}\"\n"
  epyc-container:
    name: Build epyc-container
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build epyc-container
      run: nix-build -A checks.machines.epyc-container --out-link 
        result-epyc-container
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-epyc-container
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/6\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/epyc-container\\\",\\\"description\\\":\\\"\
        epyc-container\\\"}\"\n"
  fischer:
    name: Build fischer
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build fischer
      run: nix-build -A checks.machines.fischer --out-link result-fischer
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-fischer
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/7\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/fischer\\\",\\\"description\\\":\\\"fischer\\\
        \"}\"\n"
  gallifrey:
    name: Build gallifrey
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build gallifrey
      run: nix-build -A checks.machines.gallifrey --out-link result-gallifrey
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-gallifrey
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/8\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/gallifrey\\\",\\\"description\\\":\\\"gallifrey\\\
        \"}\"\n"
  gustave:
    name: Build gustave
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build gustave
      run: nix-build -A checks.machines.gustave --out-link result-gustave
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-gustave
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/9\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/gustave\\\",\\\"description\\\":\\\"gustave\\\
        \"}\"\n"
  jacques:
    name: Build jacques
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build jacques
      run: nix-build -A checks.machines.jacques --out-link result-jacques
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-jacques
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/10\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/jacques\\\",\\\"description\\\":\\\"jacques\\\
        \"}\"\n"
  lambda:
    name: Build lambda
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build lambda
      run: nix-build -A checks.machines.lambda --out-link result-lambda
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-lambda
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/11\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/lambda\\\",\\\"description\\\":\\\"lambda\\\
        \"}\"\n"
  promote:
    if: ${{ github.event_name == 'push' }}
    name: Promote to deploy
    needs:
    - akhaten
    - arcadia
    - biblios
    - core-data
    - core-security
    - darillium
    - epyc-container
    - fischer
    - gallifrey
    - gustave
    - jacques
    - lambda
    - tower
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Fast-forward deploy branch
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\nGIT_SSH_COMMAND=\"ssh -i ~/.ssh/deploy_key\" git
        push ssh://forgejo@git.luj.fr/luj/snowfield.git HEAD:deploy\n"
  tower:
    name: Build tower
    runs-on: epyc
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      name: Configure SSH for private inputs
      run: "mkdir -p ~/.ssh\necho \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\nchmod 600 ~/.ssh/deploy_key\n\
        echo \"git.luj.fr ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDJrHUzjPX0v2FX5gJALCjEJaUJ4sbfkv8CBWc6zm0Oe\"\
        \ >> ~/.ssh/known_hosts\n"
    - env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/deploy_key
      name: Build tower
      run: nix-build -A checks.machines.tower --out-link result-tower
    - env:
        STORE_ENDPOINT: https://cache.luj.fr/snowfield
        STORE_PASSWORD: ${{ secrets.SNIX_CACHE_PASSWORD }}
        STORE_USER: ci
      name: Push to cache
      run: bash scripts/push-to-cache.sh ./result-tower
    - env:
        COMMIT_SHA: ${{ github.sha }}
        GH_TOKEN: ${{ secrets.GH_STATUS_TOKEN }}
        JOB_STATUS: ${{ job.status }}
        RUN_NUMBER: ${{ github.run_number }}
      if: always()
      name: Report status to GitHub
      run: "STATE=\"$JOB_STATUS\"\nif [ \"$STATE\" = \"cancelled\" ]; then STATE=error;
        fi\nTARGET_URL=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$RUN_NUMBER/jobs/12\"\
        \ncurl -sS -X POST \\\n  -H \"Authorization: token $GH_TOKEN\" \\\n  -H \"\
        Accept: application/vnd.github+json\" \\\n  \"https://api.github.com/repos/julienmalka/snowfield/statuses/$COMMIT_SHA\"\
        \ \\\n  -d \"{\\\"state\\\":\\\"$STATE\\\",\\\"target_url\\\":\\\"$TARGET_URL\\\
        \",\\\"context\\\":\\\"forgejo/tower\\\",\\\"description\\\":\\\"tower\\\"\
        }\"\n"
name: Evaluate and build machines
on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
